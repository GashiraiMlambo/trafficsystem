<header class="app-header" role="banner">
  <div class="header-left">
    <!-- Mobile Hamburger Menu Button -->
    <button
      class="hamburger-menu"
      (click)="toggleSidebar.emit()"
      [attr.aria-label]="'Toggle sidebar navigation'"
     >
      <span class="line"></span>
      <span class="line"></span>
      <span class="line"></span>
    </button>

    <div class="logo-area">
      <img src="assets/road-safety-logo.png" alt="Road Safety Logo" class="logo" />
      <span class="app-title">Road Safety System</span>
    </div>

    <!-- Breadcrumb Navigation (Desktop Only) -->
    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
      <ol class="breadcrumb-list">
        @for (crumb of breadcrumbs(); track crumb.label) {
          <li class="breadcrumb-item">
            @if (crumb.route) {
              <a [routerLink]="crumb.route">{{ crumb.label }}</a>
            } @else {
              <span>{{ crumb.label }}</span>
            }
          </li>
        }
      </ol>
    </nav>
  </div>

  <div class="header-center">
    <!-- Search Bar (Desktop Only) -->
    <div class="search-bar" role="search" [attr.aria-label]="'Search drivers, vehicles, and incidents'">
      <input
        type="text"
        placeholder="Search..."
        [(ngModel)]="searchQuery"
        (input)="onSearchInput()"
        aria-label="Search input"
      />
      @if (searchResults().length > 0 && searchQuery()) {
        <div class="search-results">
          @for (result of searchResults(); track result.id) {
            <div class="search-result-item" (click)="selectSearchResult(result)">
              {{ result.name }} ({{ result.type }})
            </div>
          }
        </div>
      }
      <button type="button" class="search-icon" aria-label="Perform search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-5 h-5"
        >
          <path
            fill-rule="evenodd"
            d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 4.95l4.603 4.603a.75.75 0 1 1-1.06 1.06l-4.603-4.603A8.25 8.25 0 0 1 2.25 10.5Z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
    </div>
  </div>

  <div class="header-right">
    <!-- Notification Bell -->
    <div
      class="notification-bell"
      (click)="toggleNotifications()"
      tabindex="0"
      role="button"
      aria-haspopup="true"
      [attr.aria-expanded]="showNotificationsDropdown()"
      [attr.aria-label]="'Notifications'"
      (keydown.enter)="toggleNotifications()"
      (keydown.space)="toggleNotifications()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="w-6 h-6"
      >
        <path
          fill-rule="evenodd"
          d="M5.25 9a6.75 6.75 0 0 1 13.5 0v.75c0 2.123.8 4.056 2.143 5.525a.75.75 0 0 1-1.054 1.067 8.25 8.25 0 1 0-11.667 0 .75.75 0 0 1-1.054-1.067A10.25 10.25 0 0 0 5.25 9.75V9Z"
          clip-rule="evenodd"
        />
        <path
          d="M10.75 16.5a2.25 2.25 0 0 0 4.5 0H10.75Z"
        />
      </svg>
      @if (unreadNotificationCount() > 0) {
        <span class="notification-badge">{{ unreadNotificationCount() }}</span>
      }
      @if (showNotificationsDropdown()) {
        <div class="notification-dropdown">
          <div class="dropdown-header">
            <h3>Notifications</h3>
            <button
              class="mark-all-read"
              (click)="markAllNotificationsRead()"
              aria-label="Mark all notifications as read"
            >
              Mark all as read
            </button>
          </div>
          @if (notifications().length === 0) {
            <div class="empty-state">No new notifications.</div>
          } @else {
            @for (notification of notifications(); track notification.id) {
              <div
                [class]="'notification-item ' + (notification.read ? 'read' : 'unread')"
                (click)="viewNotification(notification)"
                tabindex="0"
                (keydown.enter)="viewNotification(notification)"
                (keydown.space)="viewNotification(notification)"
                [attr.aria-label]="'Notification: ' + notification.title"
              >
                <div class="item-header">
                  <strong>{{ notification.title }}</strong>
                  <small>{{ notification.timestamp | date : 'short' }}</small>
                </div>
                <p>{{ notification.message }}</p>
                @if (!notification.read) {
                  <button
                    class="mark-read-button"
                    (click)="$event.stopPropagation(); markNotificationRead(notification.id)"
                    aria-label="Mark as read"
                  >
                    Mark as Read
                  </button>
                }
              </div>
            }
          }
        </div>
      }
    </div>

    <!-- User Avatar Dropdown -->
    <div
      class="user-dropdown"
      (click)="toggleUserDropdown()"
      tabindex="0"
      role="button"
      aria-haspopup="true"
      [attr.aria-expanded]="showUserDropdown()"
      [attr.aria-label]="'User profile and settings'"
      (keydown.enter)="toggleUserDropdown()"
      (keydown.space)="toggleUserDropdown()"
    >
      <img [src]="currentUser().avatar" alt="User Avatar" class="user-avatar" />
      <span class="user-name">{{ currentUser().name }}</span>
      <span class="user-role">{{ currentUser().role | titlecase }}</span>
      @if (showUserDropdown()) {
        <div class="dropdown-menu">
          <a routerLink="/profile" class="dropdown-item">Profile</a>
          <a routerLink="/settings" class="dropdown-item">Settings</a>
          <a (click)="logout()" class="dropdown-item logout">Logout</a>
        </div>
      }
    </div>
  </div>
</header>
